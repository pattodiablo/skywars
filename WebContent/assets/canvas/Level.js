
// -- user code here --

/* --- start generated code --- */

// Generated by  1.5.4 (Phaser v2.6.2)


/**
 * Level.
 */
function Level() {
	
	Phaser.State.call(this);
	
}

/** @type Phaser.State */
var Level_proto = Object.create(Phaser.State.prototype);
Level.prototype = Level_proto;
Level.prototype.constructor = Level;

Level.prototype.init = function () {
	
	this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
	this.scale.pageAlignHorizontally = true;
	this.scale.pageAlignVertically = true;
	this.game.renderer.renderSession.roundPixels = true;
	this.stage.backgroundColor = '#80ffff';
	
	this.myInit();
	
};

Level.prototype.preload = function () {
	
	this.load.pack('images', 'assets/pack.json');
	this.load.pack('atlas', 'assets/pack.json');
	
};

Level.prototype.create = function () {
	var _background = this.add.sprite(0.0, 0.0, 'background');
	_background.fixedToCamera = true;
	
	var _middleBG = this.add.group();
	
	var _buildings = new BgBuildings(this.game, 0.0, 69.0);
	_middleBG.add(_buildings);
	
	var _platforms = this.add.physicsGroup(Phaser.Physics.ARCADE);
	
	var _building = new building1(this.game, 0.0, 830.0);
	_platforms.add(_building);
	
	var _build = new building1(this.game, 1129.0, 735.0);
	_platforms.add(_build);
	
	var _building2Tower = new building2(this.game, 3303.0, 652.0);
	_platforms.add(_building2Tower);
	
	var _building3Tower = new building3(this.game, 2293.0, 630.0);
	_platforms.add(_building3Tower);
	
	var _player = new player(this.game, 465.0, 512.0);
	this.add.existing(_player);
	
	var _enemies = this.add.physicsGroup(Phaser.Physics.ARCADE);
	
	var _powerUps = this.add.group();
	
	var _powerLabel = this.add.group();
	_powerLabel.position.set(0.0, -595.0);
	
	var _powerText = this.add.text(64.0, 480.0, 'Double Jump', {"font":"bold 60px Arial","fill":"#ffffff","stroke":"#ffffff"}, _powerLabel);
	
	this.add.text(91.0, 453.0, 'you got', {"font":"bold 30px Arial","fill":"#ffffff","stroke":"#ffffff"}, _powerLabel);
	
	var _core1 = this.add.sprite(1728.0, 32.0, 'core1');
	_core1.fixedToCamera = true;
	_core1.tint = 0x808080;
	
	var _coins = this.add.physicsGroup(Phaser.Physics.ARCADE);
	
	var _coinSymbol = this.add.sprite(33.0, 30.0, 'powerUps', 'Symbol 4 instance 10013');
	_coinSymbol.fixedToCamera = true;
	
	var _moneyText = this.add.text(133.0, 31.0, '000001', {"font":"bold 70px Arial","fill":"#ffff80","stroke":"#ff8040"});
	_moneyText.fixedToCamera = true;
	
	var _jumpText = this.add.text(1779.0, 68.0, '0', {"font":"bold 50px Arial","fill":"#ffff80","stroke":"#ff8040"});
	_jumpText.fixedToCamera = true;
	
	
	
	// fields
	
	this.fMiddleBG = _middleBG;
	this.fPlatforms = _platforms;
	this.fPlayer = _player;
	this.fEnemies = _enemies;
	this.fPowerUps = _powerUps;
	this.fPowerLabel = _powerLabel;
	this.fPowerText = _powerText;
	this.fCore1 = _core1;
	this.fCoins = _coins;
	this.fMoneyText = _moneyText;
	this.fJumpText = _jumpText;
	this.myCreate();
	
	
};

/* --- end generated code --- */
// -- user code here --


Level.prototype.myInit = function () {
	this.stageSpeed = 300;
	this.maximunStageSpeed = 600;

}
Level.prototype.myCreate = function () {


	this.game.input.onDown.add(this.swipeDownAction, this);
	this.game.input.onUp.add(this.swipeUpAction, this);
	this.game.world.setBounds(0, 0, 1920, 1100);
	this.game.camera.follow(this.fPlayer,Phaser.Camera.FOLLOW_LOCKON,0.01, 0.01,0,0);
	this.jumpPower = -900;

    enemyDeployTimer = this.game.time.create(false);
    enemyDeployTimer.loop(2000, this.deployItems, this);
    enemyDeployTimer.start();
	//this.setupCoinEmitter();

};

Level.prototype.deployItems = function() {

const wichItem =  Math.random() < 0.2;
const enemyXDeploy = Math.random()  * (600 - 200) + 200;

if(wichItem){

	const wichItem2 =  Math.random() < 0.9;
	

	if(wichItem2){
		var _itemPowerUp = new powerUp1(this.game, this.game.width+50, enemyXDeploy);
		this.fPowerUps.add(_itemPowerUp);
	}else{
		var _itemPowerUp = new powerUp2(this.game, this.game.width+50, enemyXDeploy);
		this.fPowerUps.add(_itemPowerUp);
	}
	


}else{


var _BirdEnemy = new wisherEnemy(this.game, this.game.width+50, enemyXDeploy);
	this.fEnemies.add(_BirdEnemy);
}


};

Level.prototype.swipeUpAction = function(pointer) { 
this.fPlayer.isKicking = false;
this.jumpPower=0;
};


Level.prototype.swipeDownAction = function(pointer) { //manejo de swipe control de pantalla
	


	
	if(!this.fPlayer.canJump && this.fPlayer.canKick){
		const wichKick = Math.random()*10;
		if(wichKick>=5){
			this.fPlayer.animations.stop('down');
			this.fPlayer.animations.play('kick');
		}else{
			this.fPlayer.animations.stop('down');
			this.fPlayer.animations.play('kick2');
		}
		
		this.fPlayer.isKicking = true;
	}

	if(this.fPlayer.canJump){
		this.fPlayer.body.velocity.x =  50;
		this.fPlayer.body.velocity.y=-900;
		this.fPlayer.animations.play('up');
		this.fPlayer.canJump =  false;
		this.fPlayer.canKick = true;
		this.fPlayer.isKicking = false;

		
	}else if(this.fPlayer.canDoubleJump && this.fPlayer.isFalling){
		this.fPlayer.body.velocity.y=-1000;
			this.fPlayer.canDoubleJump = false;
			this.fPlayer.myDoubleJump--;
	}
	

				};


Level.prototype.onPlatform = function (player, platform) {

if(platform.x>this.game.width/3){

player.body.velocity.x = platform.body.velocity.x;	
}else{

	player.body.velocity.x = -30;	
}
	
	player.canJump =  true;
	player.canKick = false;
	player.isKicking= false;

	this.fPlayer.animations.play('run');

	if(platform.body.touching.left){
		player.canJump =  false;
			
	}

	};	

Level.prototype.coinOnPlatform = function (coin, platform) {



coin.body.velocity.x = platform.body.velocity.x;	


	};	

Level.prototype.destroyEnemy = function (player, enemy) {	


	if(player.isKicking){
			var _kickPower = new kickPower(this.game, enemy.x, enemy.y);
			_kickPower.alpha = 0.5;
		this.shakeAndFlash();
		this.createCoins(enemy.x,enemy.y,300);
		this.add.existing(_kickPower);
		enemy.animations.play('kicked');
		enemy.tweenBtn.stop();
		enemy.body.velocity.x=800;
		enemy.body.gravity.y=1200;
	}
};



Level.prototype.createCoins = function (x,y,velo) {

	var _coin = new coin(this.game, x, y);
	_coin.body.velocity.y=Math.random()*velo;
	_coin.body.velocity.x=Math.random()*velo;
	this.fCoins.add(_coin);

}

Level.prototype.shakeAndFlash = function () {
		this.game.camera.shake(0.02, 120);
  		this.game.camera.flash(0xffffff, 250)
};

Level.prototype.getPowerUp = function (player,powerUp) {
	
	this.shakeAndFlash();
	if(powerUp.myPower == 'doubleJump'){
		player.myDoubleJump++;
			this.fPowerText.text = 'Double Jump';
			

	}

	if(powerUp.myPower == 'speedForce'){
		if(!this.fPlayer.usingSpeedForce){


			
		fly = this.game.add.tween(this.fPlayer);
		fly.to({x:this.game.width/2 , y:this.game.height/3}, 500, Phaser.Easing.Linear.None);
		fly.start();

		this.fPlayer.usingSpeedForce =  true;
		this.fPowerText.text = 'Speed Force';
		this.fPlayer.x = this.game.width/2;
		this.fPlayer.y = this.game.height/3;
		this.fPlayer.body.moves = false;
		this.maximunStageSpeed=1000;
		this.stageSpeed=1000;

		this.timerPower = this.game.time.create(false);
    	this.timerPower.loop(3000, slowAgain, this);
   		this.timerPower.start();

   		this.speedPowerInstance = new speedPower(this.game, this.fPlayer.x, this.fPlayer.y);
		this.add.existing(this.speedPowerInstance);

   		this.fEnemies.forEach(enemy => {
  			enemy.speedKill =  true;
		});

   		function slowAgain(){
			this.speedPowerInstance.destroy();
   			this.fEnemies.forEach(enemy => {
  			enemy.speedKill =  false;
			});
			this.fPlayer.usingSpeedForce =  false;
   			this.fPlayer.body.moves = true;
   			this.maximunStageSpeed=600;
   			this.timerPower.destroy();
   		}
		
	}

			pigArrives = this.game.add.tween(this.fPowerLabel);
		    pigArrives.to({y:-240}, 1200, Phaser.Easing.Bounce.Out);
		    pigArrives.onComplete.add(theEnd, this);
		    pigArrives.start();
		    
		    function theEnd() {
		    
		    e = this.game.add.tween(this.fPowerLabel);
		    
		    e.to({ y: -600 }, 500, Phaser.Easing.Bounce.Out);
		    e.start();

			}

	
}
powerUp.destroy();

};

Level.prototype.update = function () {

	if(this.fPlayer.myDoubleJump>0){
		this.fPlayer.canDoubleJump =  true;
	}
	if(this.stageSpeed>=this.maximunStageSpeed){

		this.stageSpeed = this.maximunStageSpeed;

	}else{
		this.stageSpeed++;
	}

	
	this.fMoneyText.text = this.fPlayer.coins;
	this.fJumpText.text = this.fPlayer.myDoubleJump;

	this.game.physics.arcade.collide(this.fCoins , this.fPlatforms, this.coinOnPlatform, null, this);
	this.game.physics.arcade.collide(this.fPlayer , this.fPlatforms, this.onPlatform, null, this);
	this.game.physics.arcade.overlap(this.fPlayer , this.fEnemies, this.destroyEnemy, null, this);
	this.game.physics.arcade.overlap(this.fPlayer , this.fPowerUps, this.getPowerUp, null, this);

	if(this.fPlayer.y>=this.game.height+100){ //muere die lost loose
		this.fPlayer.coins-=10;
		this.fPlayer.y = -50;
		for(var i = 0 ; i<=15; i++){
			this.createCoins(this.game.width/2,0,1500);
		}
	
		this.fPlayer.x = this.game.width/2;
		this.shakeAndFlash();
	}

	if(this.fPlayer.canDoubleJump){
		this.fCore1.alpha=1;
		this.fCore1.tint=0xffffff;
	}else{
		this.fCore1.alpha=0.5;
		this.fCore1.tint=0x808080;
	}
};