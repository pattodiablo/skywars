
// -- user code here --
	var musicEnabled = true;
	var fxEnabled = true;
/* --- start generated code --- */

// Generated by  1.5.4 (Phaser v2.6.2)


/**
 * Level.
 */
function Level() {
	
	Phaser.State.call(this);
	
}

/** @type Phaser.State */
var Level_proto = Object.create(Phaser.State.prototype);
Level.prototype = Level_proto;
Level.prototype.constructor = Level;

Level.prototype.init = function () {
	
	this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
	this.scale.pageAlignHorizontally = true;
	this.scale.pageAlignVertically = true;
	this.game.renderer.renderSession.roundPixels = true;
	this.stage.backgroundColor = '#80ffff';
	
	this.myInit();
	
};

Level.prototype.preload = function () {
	
	this.load.pack('images', 'assets/pack.json');
	this.load.pack('atlas', 'assets/pack.json');
	
	this.myPreload();
	
};

Level.prototype.create = function () {
	var _background = this.add.sprite(0.0, 0.0, 'background');
	_background.fixedToCamera = true;
	
	var _middleBG = this.add.group();
	
	var _buildings = new BgBuildings(this.game, 0.0, 69.0);
	_middleBG.add(_buildings);
	
	var _platforms = this.add.physicsGroup(Phaser.Physics.ARCADE);
	
	var _building = new building1(this.game, 0.0, 634.0);
	_platforms.add(_building);
	
	var _building2Tower = new building2(this.game, 3302.0, 590.0);
	_platforms.add(_building2Tower);
	
	var _building3Tower = new building3(this.game, 2293.0, 785.0);
	_platforms.add(_building3Tower);
	
	var _build2 = new building1(this.game, 4604.0, 659.0);
	_platforms.add(_build2);
	
	var _powerLabel = this.add.group();
	_powerLabel.position.set(0.0, -595.0);
	
	var _powerText = this.add.text(64.0, 456.0, 'Double Jump', {"font":"bold 120px Arial","fill":"#ffffff","stroke":"#ffffff"}, _powerLabel);
	
	this.add.text(87.0, 397.0, 'You got', {"font":"bold 60px Arial","fill":"#ffffff","stroke":"#ffffff"}, _powerLabel);
	
	var _enemies = this.add.physicsGroup(Phaser.Physics.ARCADE);
	
	var _powerUps = this.add.group();
	
	var _coins = this.add.physicsGroup(Phaser.Physics.ARCADE);
	
	var _bullets = this.add.physicsGroup(Phaser.Physics.ARCADE);
	
	var _menu = new menuBg(this.game);
	_menu.position.set(9.0, -947.0);
	
	var _player = new player(this.game, 465.0, 512.0);
	this.add.existing(_player);
	
	var _musicBtn = new musicBtn(this.game, 79.0, 1005.0);
	this.add.existing(_musicBtn);
	
	var _FxBtn = new FxBtn(this.game, 219.0, 1005.0);
	this.add.existing(_FxBtn);
	
	
	
	// fields
	
	this.fMiddleBG = _middleBG;
	this.fPlatforms = _platforms;
	this.fPowerLabel = _powerLabel;
	this.fPowerText = _powerText;
	this.fEnemies = _enemies;
	this.fPowerUps = _powerUps;
	this.fCoins = _coins;
	this.fBullets = _bullets;
	this.fMenu = _menu;
	this.fPlayer = _player;
	this.myCreate();
	
	
};

/* --- end generated code --- */
// -- user code here --


Level.prototype.myInit = function () {
	this.stageSpeed = 300;
	this.maximunStageSpeed = 600;

};

Level.prototype.myPreload = function () {
this.game.load.audio('bgmusic1', ['assets/audio/bgmusic1.mp3','assets/audio/bgmusic1.ogg']);


};


Level.prototype.myCreate = function () {

	

	this.createCoins(this.fPlayer.x,this.fPlayer.y,300,false);
	this.kickLevel = 0;
	this.initSound = false;
	this.game.input.onDown.add(this.swipeDownAction, this);
	this.game.input.onUp.add(this.swipeUpAction, this);
	this.game.world.setBounds(0, 0, 1920, 1100);
	this.game.camera.follow(this.fPlayer, Phaser.Camera.FOLLOW_LOCKON,0.01, 0.01,0,0);
	this.jumpPower = -900;

    enemyDeployTimer = this.game.time.create(false);
    enemyDeployTimer.loop(1250, this.deployItems, this);
    enemyDeployTimer.start();

  	
	//this.setupCoinEmitter();


};

Level.prototype.bgMusicPlay = function () {

	BgMusic = this.game.add.audio('bgmusic1', 0.3); //agregar musica y volumen
	BgMusic.allowMultiple = false;
	BgMusic.loop = true;


	BgMusic2 = this.game.add.audio('bgmusic2', 0.3); //agregar musica y volumen
	BgMusic2.allowMultiple = false;
	BgMusic2.loop = true;
	
	var BgMusicSelector = Math.round(Math.random()) //agreagar musica de bg randomicamente
	BgMusic.play();
	switch (this.game.musicOption){

		case "1":
			console.log('rola 1 selected!');
			this.BgMusic = 1;
			BgMusic.play();
		break;
			

		case "2":
			console.log('rola 2 selected!');
			this.BgMusic = 2;
			BgMusic2.play();
		break;

		default:
			console.log('no rola selected');
		break;

	}
	

	hurt = this.game.add.audio('hurt', 0.2);
	hurt.allowMultiple = false;
	hurt.addMarker('hurt', 0, 0.15	);

	getFuel = this.game.add.audio('getFuel', 0.2);
	getFuel.allowMultiple = false;
	getFuel.addMarker('getFuel', 0, 0.30	);

	pickCristal = this.game.add.audio('pickCristal', 0.2);
	pickCristal.allowMultiple = true;
	pickCristal.addMarker('pickCristal', 0, 0.18	);

	elevate1 = this.game.add.audio('elevate1', 0.2);
	elevate1.allowMultiple = true;
	elevate1.addMarker('elevate1', 0, 0.13	);

	elevate2 = this.game.add.audio('elevate2', 0.2);
	elevate2.allowMultiple = true;
	elevate2.addMarker('elevate2', 0, 0.13	);

	elevate3 = this.game.add.audio('elevate3', 0.2);
	elevate3.allowMultiple = true;
	elevate3.addMarker('elevate3', 0, 0.13	);

	this.fxSounds = [hurt,getFuel,pickCristal,elevate1,elevate2,elevate3]; //agreagar aqui todos los sound fx que se necesita adminstrar

	if(!fxEnabled){
		this.fxSounds.forEach(function(soundFx) { 	 //en caso de que se deshabilite los sonidos fxs
		soundFx.mute = true;
	},this);
	}

}

Level.prototype.switchMusic = function () {


	if(musicEnabled){

		BgMusic.pause();
		BgMusic2.pause();
		musicEnabled = false;
		console.log('musica disabled');
		

	}else{
	

		if(this.BgMusic = 1){

			BgMusic.play();

		}else{

			BgMusic2.stop();

		}
		
		musicEnabled = true;
			console.log('musica musicEnabled');
	}


	};

Level.prototype.switchFX = function () {
	

	if(fxEnabled){


	this.fxSounds.forEach(function(soundFx) { 	

		soundFx.mute = true;


	},this);

		fxEnabled = false;
		console.log('fx disabled');
		

	}else{
	
	this.fxSounds.forEach(function(soundFx) { 	

	soundFx.mute = false;


	},this);
	
		
		fxEnabled = true;
		console.log('fx enabled');
	}


	};

Level.prototype.deployItems = function() {

var itemAppearChance = (this.fPlayer.core1Level + this.fPlayer.core2Level + this.fPlayer.core3Level)/10;

const enemyXDeploy = Math.random()  * (550 - 200) + 200;

if(itemAppearChance>=0.5){
	itemAppearChance = 0.5;
}

const salen =  Math.random() < itemAppearChance;

if(salen){

	const wichSale =  Math.round(Math.random() * 3);
	

	if(this.fPlayer.core1Level>=1 && wichSale<=1){
		const item1Cap = this.fPlayer.core1Level/10;
		const isItem1Able =  Math.random() < (0.5+item1Cap);

		if(isItem1Able){
			var _itemPowerUp = new powerUp1(this.game, this.game.width+50, enemyXDeploy);
			this.fPowerUps.add(_itemPowerUp);
		}
	}

	if(this.fPlayer.core2Level>=1 && wichSale==2){
		const item2Cap = this.fPlayer.core2Level/10;
		const isItem2Able =  Math.random() < (0.5+item2Cap);

		if(isItem2Able){
			var _itemPowerUp = new powerUp2(this.game, this.game.width+50, enemyXDeploy);
			this.fPowerUps.add(_itemPowerUp);
		}
	}

	if(this.fPlayer.core3Level>=1 && wichSale==3){
		const item3Cap = this.fPlayer.core3Level/10;
		const isItem3Able =  Math.random() < (0.5+item3Cap);

		if(isItem3Able){
			var _itemPowerUp = new powerUp3(this.game, this.game.width+50, enemyXDeploy);
			this.fPowerUps.add(_itemPowerUp);
		}
	}
}




var _BirdEnemy = new wisherEnemy(this.game, this.game.width+50, enemyXDeploy);
	this.fEnemies.add(_BirdEnemy);

};

Level.prototype.swipeUpAction = function(pointer) { 
this.fPlayer.isKicking = false;
this.jumpPower=0;
};


Level.prototype.swipeDownAction = function(pointer) { //manejo de swipe control de pantalla
	

if(!this.initSound){

	  this.bgMusicPlay();
	  this.initSound=true;
}
	
	if(!this.fPlayer.canJump && this.fPlayer.canKick){
		const wichKick = Math.random()*10;
		if(wichKick>=5){
			this.fPlayer.animations.stop('down');
			this.fPlayer.animations.play('kick');
		}else{
			this.fPlayer.animations.stop('down');
			this.fPlayer.animations.play('kick2');
		}
		
		this.fPlayer.isKicking = true;
	}

	if(this.fPlayer.canJump){
		this.fPlayer.body.velocity.x =  50;
		this.fPlayer.body.velocity.y=-900;
		this.fPlayer.animations.play('up');
		this.fPlayer.canJump =  false;
		this.fPlayer.canKick = true;
		this.fPlayer.isKicking = false;

		
	}else if(this.fPlayer.canDoubleJump && this.fPlayer.isFalling){
		this.fPlayer.body.velocity.y=-1000;
			//this.fPlayer.canDoubleJump = false;
			this.fPlayer.myDoubleJump--;
	}
	

				};


Level.prototype.onPlatform = function (player, platform) {

if(platform.x>this.game.width/3){

player.body.velocity.x = platform.body.velocity.x;	
}else{

	player.body.velocity.x = -30;	
}
	
	player.canJump =  true;
	player.canKick = false;
	player.isKicking= false;

	this.fPlayer.animations.play('run');

	if(platform.body.touching.left){
		player.canJump =  false;
			
	}

	};	

Level.prototype.coinOnPlatform = function (coin, platform) {



coin.body.velocity.x = platform.body.velocity.x;	


	};	
Level.prototype.getExperience = function (enemy) {	

if(this.fPlayer.ExpPoints>=this.kickLevel){
	const randScale = Math.random()*1;
	var _expLabel = new expLabel(this.game,enemy.x, enemy.y);
	_expLabel.y = enemy.y-60*randScale;
	_expLabel.scale.setTo(randScale,randScale);
	this.add.existing(_expLabel);
	this.kickLevel++;
}

this.fPlayer.getExp();


}

Level.prototype.destroyEnemy = function (player, enemy) {	

	
	if(player.isKicking){
					
			var _kickPower = new kickPower(this.game, enemy.x, enemy.y);
			_kickPower.alpha = 0.5;
			this.shakeAndFlash();
			this.createCoins(enemy.x,enemy.y,300,false);
			this.add.existing(_kickPower);
			enemy.animations.play('kicked');
			enemy.tweenBtn.stop();
			enemy.tween2Btn.stop();
			enemy.body.velocity.x=800;
			enemy.body.gravity.y=1200;
			this.getExperience(enemy);
	}
	
};

Level.prototype.destroyEnemyWithLevel = function (player, enemy) {	

			this.shakeAndFlash();
			for(var i=0; i<=10; i++){

			this.createCoins(enemy.x,enemy.y,300,true);	
			}
			
			
			enemy.animations.play('kicked');
			enemy.tweenBtn.stop();
			if(enemy.x>this.fPlayer.x){
				enemy.body.velocity.x=800;
			}else{
				enemy.body.velocity.x=-800;
			}
			
			enemy.body.gravity.y=1200;
			this.getExperience(enemy);

	
};

Level.prototype.destroyEnemyWithBullet = function (bullet, enemy) {	
		this.getExperience(enemy);
		this.shakeAndFlash();
		this.createCoins(enemy.x,enemy.y,-800,true);
		enemy.body.velocity.x=800;
		enemy.body.gravity.y=1200;
};

Level.prototype.createCoins = function (x,y,velo,killedByBullet) {

	var _coin = new coin(this.game, x, y);
	_coin.killedByBullet = killedByBullet;
	_coin.body.velocity.y=Math.random()*velo;
	_coin.body.velocity.x=Math.random()*velo;
	this.fCoins.add(_coin);

}

Level.prototype.shakeAndFlash = function () {
		this.game.camera.shake(0.02, 120);
  		this.game.camera.flash(0xffffff, 250)
};

Level.prototype.getPowerUp = function (player,powerUp) {
	
	if(!this.fPlayer.usingDoubleJump || !this.fPlayer.usingSpeedForce || !this.fPlayer.canShot){
	this.shakeAndFlash();
		if(powerUp.myPower == 'SuperShot'){
			console.log('i got superShot');
			this.fPowerText.text = 'Super Shot';
			player.canShot=true;

			switch(player.core3Level){

				case 1:
					powerUpTimer3 = 2000;
				break;

				case 2:
					powerUpTimer3 = 3000;
				break;

				case 3:
					powerUpTimer3 = 4000;
				break;

				default:
					powerUpTimer3 = 1000;
				break;
			}
		

			this.timerPower3 = this.game.time.create(false);
	    	this.timerPower3.loop(powerUpTimer3, quitSuperShot, this);
	   		this.timerPower3.start();

   			function quitSuperShot(){
   				player.canShot=false;
				player.enableShootOnce =true;
				this.timerPower3.destroy();
   			}
			
		}

	if(powerUp.myPower == 'doubleJump'){
		if(!this.fPlayer.usingDoubleJump){

			this._jumpPower_instance_ = new jumpPower(this.game, this.fPlayer.x, this.fPlayer.y);
			this.add.existing(this._jumpPower_instance_);
	
			player.myDoubleJump++;
			player.canDoubleJump=true;
			this.fPlayer.usingDoubleJump =  true;
			this.fPowerText.text = 'Multi Jump';
		
			switch(player.core1Level){

				case 1:
					powerUpTimer2 = 3000;
				break;

				case 2:
					powerUpTimer2 = 5000;
				break;

				case 3:
					powerUpTimer2 = 7000;
				break;

				default:
					powerUpTimer2 = 2000;
				break;
			}
		

			this.timerPower2 = this.game.time.create(false);
	    	this.timerPower2.loop(powerUpTimer2, quitDoubleJump, this);
	   		this.timerPower2.start();

   			function quitDoubleJump(){

   				this._jumpPower_instance_.destroy();
   				this.fPlayer.usingDoubleJump =  false;
				player.canDoubleJump=false;
	   			this.timerPower2.destroy();

   			}
		}
	}

	if(powerUp.myPower == 'speedForce'){
		if(!this.fPlayer.usingSpeedForce){
		
		fly = this.game.add.tween(this.fPlayer);
		fly.to({x:this.game.width/2 , y:this.game.height/3}, 500, Phaser.Easing.Linear.None);
		fly.start();

		this.fPlayer.usingSpeedForce =  true;
		this.fPowerText.text = 'Speed Force';
		this.fPlayer.x = this.game.width/2;
		this.fPlayer.y = this.game.height/3;
		this.fPlayer.body.moves = false;
		this.maximunStageSpeed=1500;
		this.stageSpeed=1500;

		switch(player.core3Level){

				case 1:
					powerUpTimer1 = 1500;
				break;

				case 2:
					powerUpTimer1 = 2000;
				break;

				case 3:
					powerUpTimer1 = 2500;
				break;

				default:
					powerUpTimer1 = 1000;
				break;
			}

		this.timerPower = this.game.time.create(false);
    	this.timerPower.loop(powerUpTimer1, slowAgain, this);
   		this.timerPower.start();

   		this.speedPowerInstance = new speedPower(this.game, this.fPlayer.x, this.fPlayer.y);
		this.add.existing(this.speedPowerInstance);

   		this.fEnemies.forEach(function(enemy){
  			enemy.speedKill =  true;
		});

   		function slowAgain(){
			this.speedPowerInstance.destroy();
   			this.fEnemies.forEach(function(enemy){
  			enemy.speedKill =  false;
			});
			this.fPlayer.usingSpeedForce =  false;
   			this.fPlayer.body.moves = true;
   			this.maximunStageSpeed=600;
   			this.timerPower.destroy();
   		};
		
	};

			
}
	this.showLabel();
}
			
			
			powerUp.destroy();

};

Level.prototype.showLabel = function () {
			bajaLetrero = this.game.add.tween(this.fPowerLabel);		
		    bajaLetrero.to({y:-240}, 1200, Phaser.Easing.Bounce.Out);
		    bajaLetrero.onComplete.add(theEnd, this);
		    bajaLetrero.start();
		    
		    function theEnd() {
		    
		    e = this.game.add.tween(this.fPowerLabel);
		    
		    e.to({ y: -600 }, 500, Phaser.Easing.Bounce.Out);
		    e.start();

			}
}

Level.prototype.newLevelAnim = function () {

		

		this.fPlayer.usingSpeedForce =  true;
		this.fPowerText.text = 'Speed Force';

		this.timerPower = this.game.time.create(false);
    	this.timerPower.loop(500, slowAgain, this);
   		this.timerPower.start();

   		this.speedPowerInstance = new jumpPower(this.game, this.fPlayer.x, this.fPlayer.y);
		this.add.existing(this.speedPowerInstance);

		explode = this.game.add.tween(this.speedPowerInstance.scale);
		explode.to({x:20 , y:20}, 500, Phaser.Easing.Linear.None);
		explode.start();


   		this.fEnemies.forEach(function(enemy){
  			enemy.game.state.getCurrentState().destroyEnemyWithLevel(this.fPlayer,enemy);
		});

   		function slowAgain(){
			this.speedPowerInstance.destroy();
   			this.fEnemies.forEach(function(enemy){
  			enemy.speedKill =  false;
			});
			this.fPlayer.usingSpeedForce =  false;
   			this.fPlayer.body.moves = true;
   			this.maximunStageSpeed=600;
   			this.timerPower.destroy();
   		};

}


Level.prototype.update = function () {

	//this.fPlayer.getExp();
	
	if(this.fPlayer.myDoubleJump>0){
		this.fPlayer.canDoubleJump =  true;
	}
	if(this.stageSpeed>=this.maximunStageSpeed){

		this.stageSpeed = this.maximunStageSpeed;

	}else{
		this.stageSpeed++;
	}

	
	this.fMenu.fLevelBar.fMoneyText.text = this.fPlayer.coins;
	
	this.game.physics.arcade.collide(this.fBullets , this.fEnemies, this.destroyEnemyWithBullet, null, this);
	this.game.physics.arcade.collide(this.fCoins , this.fPlatforms, this.coinOnPlatform, null, this);
	this.game.physics.arcade.collide(this.fPlayer , this.fPlatforms, this.onPlatform, null, this);
	this.game.physics.arcade.overlap(this.fPlayer , this.fEnemies, this.destroyEnemy, null, this);
	this.game.physics.arcade.overlap(this.fPlayer , this.fPowerUps, this.getPowerUp, null, this);

	if(this.fPlayer.y>=this.game.height+100){ //muere die lost loose
		this.fPlayer.coins-=Math.round(10+this.fPlayer.coins*0.1);
		this.fPlayer.y = -50;
		this.fPlayer.body.velocity.x = 200;
		
		for(var i = 0 ; i<=10; i++){
			this.createCoins(this.game.width/2,0,1500);
		}
		this.stageSpeed -= 20;
		if(this.stageSpeed<=100){

			this.stageSpeed=100
		}
		
		this.fPlayer.x = this.game.width/2;
		this.shakeAndFlash();
	}

	
};